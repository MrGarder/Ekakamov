<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Ekakamov | Состав семьи</title>
    <style>
        :root {
            --primary: #8b0000;
            --accent: #ff0000;
            --bg: #050505;
            --card-bg: #111;
            --online: #00ff00;
            --offline: #555;
        }

        body { background-color: var(--bg); color: #fff; font-family: 'Segoe UI', sans-serif; margin: 0; }

        header { 
            background: linear-gradient(180deg, var(--primary) 0%, #000 100%);
            padding: 30px 20px; text-align: center; border-bottom: 3px solid var(--accent); 
            text-transform: uppercase; letter-spacing: 3px;
        }

        nav { 
            display: flex; justify-content: center; background: rgba(17, 17, 17, 0.95); 
            padding: 15px; border-bottom: 1px solid #333; position: sticky; top: 0; z-index: 100;
            backdrop-filter: blur(5px);
        }

        nav a { 
            color: #aaa; margin: 0 15px; text-decoration: none; font-weight: bold; 
            text-transform: uppercase; font-size: 12px; transition: 0.3s;
        }

        nav a:hover { color: var(--accent); text-shadow: 0 0 8px var(--accent); }

        .container { max-width: 1000px; margin: 40px auto; padding: 0 20px; }

        .stats-bar { display: flex; justify-content: center; gap: 20px; margin-bottom: 20px; }
        .stat-item { background: var(--card-bg); padding: 10px 20px; border-radius: 5px; border: 1px solid #222; font-size: 0.9em; text-transform: uppercase; }
        
        .member-table { width: 100%; border-collapse: separate; border-spacing: 0 8px; }
        .member-table th { color: #888; text-transform: uppercase; font-size: 11px; padding: 10px 15px; text-align: left; }
        .member-table tr { background: var(--card-bg); transition: 0.3s; }
        .member-table td { padding: 15px; border-top: 1px solid #222; border-bottom: 1px solid #222; }
        .member-table td:first-child { border-left: 1px solid #222; border-radius: 8px 0 0 8px; }
        .member-table td:last-child { border-right: 1px solid #222; border-radius: 0 8px 8px 0; }

        .status-cell { cursor: pointer; user-select: none; transition: 0.2s; }
        .status-cell:hover { background: #1a1a1a; }
        
        .pulse { display: none; width: 8px; height: 8px; background: var(--online); border-radius: 50%; margin-right: 8px; box-shadow: 0 0 8px var(--online); vertical-align: middle; }

        tr.is-online .pulse { display: inline-block; animation: blink 1.5s infinite; }
        tr.is-online .status-text::after { content: "В игре"; color: var(--online); font-weight: bold; }
        tr.is-offline .status-text::after { content: "Оффлайн"; color: var(--offline); }

        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }

        /* ЦВЕТА РАНГОВ */
        .rank-badge { padding: 5px 12px; border-radius: 4px; font-weight: bold; font-size: 11px; text-transform: uppercase; display: inline-block; color: #fff; }
        
        .rank-10 { background: #ff0000; box-shadow: 0 0 15px rgba(255,0,0,0.5); border: 1px solid #fff; }
        .rank-9  { background: #8b0000; border: 1px solid #ff0000; }
        .rank-8  { background: #ff8c00; }
        .rank-7  { background: #ffd700; color: #000; }
        .rank-6  { background: #4b0082; }
        .rank-5  { background: #00008b; }
        .rank-4  { background: #006400; }
        .rank-3  { background: #444; }
        .rank-2  { background: #888; color: #000; }
        .rank-1  { background: #555; color: #ccc; }

        .avatar-circle { 
            width: 35px; height: 35px; background: linear-gradient(45deg, #222, #333); 
            border-radius: 50%; display: inline-block; vertical-align: middle; 
            margin-right: 12px; border: 1px solid #444; text-align: center; 
            line-height: 35px; color: var(--accent); font-weight: bold; 
        }

        .section-title { text-align: center; text-transform: uppercase; color: var(--accent); letter-spacing: 2px; margin: 60px 0 30px; }
        .desc-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 15px; }
        .desc-item { background: #0a0a0a; padding: 15px; border-radius: 8px; border: 1px solid #222; font-size: 0.9em; line-height: 1.4; }
        .desc-item b { color: var(--accent); display: block; margin-bottom: 5px; }
        .warn-count { color: #ffae00; font-family: monospace; font-weight: bold; }
    </style>
</head>
<body>

    <header><h1>EKAKAMOV FAMILY</h1></header>

    <nav>
        <a href="index.html">Главная</a>
        <a href="members.html">Состав</a>
        <a href="rules.html">Устав</a>
        <a href="reports.html">Отчеты</a>
        <a href="rankup.html">Повышение</a>
        <a href="unwarn.html">Выговоры</a>
    </nav>

    <div class="container">
        <div class="stats-bar">
            <div class="stat-item">Всего: <b id="total-count">0</b></div>
            <div class="stat-item">В сети: <b style="color:var(--online)" id="online-count">0</b></div>
        </div>

        <table class="member-table">
            <thead>
                <tr>
                    <th>Участник</th>
                    <th>Должность</th>
                    <th>Выговоры</th>
                    <th>Статус</th>
                </tr>
            </thead>
            <tbody id="member-list"></tbody>
        </table>

        <h2 class="section-title">Иерархия полномочий</h2>
        <div class="desc-grid" id="hierarchy-box"></div>
    </div>

    <script>
        const hierarchy = [
            {r: 10, n: "Глава", d: "Лидер семьи."},
            {r: 9, n: "Зам. Главы", d: "Правая рука лидера."},
            {r: 8, n: "Гольд", d: "Старший советник."},
            {r: 7, n: "Шерх", d: "Тренер состава."},
            {r: 6, n: "Элит", d: "Опытный боец."},
            {r: 5, n: "Ветеран", d: "Наставник."},
            {r: 4, n: "Боец", d: "Участник захватов."},
            {r: 3, n: "Новичок+", d: "Лояльный участник."},
            {r: 2, n: "Равк", d: "Сдал устав."},
            {r: 1, n: "Кандидат", d: "На проверке."}
        ];

        const hBox = document.getElementById('hierarchy-box');
        hierarchy.forEach(item => {
            hBox.innerHTML += `<div class="desc-item"><b>[${item.r}] ${item.n}</b> ${item.d}</div>`;
        });

        // Функция для извлечения числа из строки типа "[10] Глава"
        function extractRankNumber(rankStr) {
            const match = String(rankStr).match(/\d+/); // Ищет первое число в строке
            return match ? parseInt(match[0]) : 1;
        }

        async function loadData() {
            try {
                const response = await fetch('/get-statuses');
                const data = await response.json();
                const list = document.getElementById('member-list');
                list.innerHTML = '';

                const sortedNames = Object.keys(data).sort((a, b) => {
                    return extractRankNumber(data[b].rank) - extractRankNumber(data[a].rank);
                });

                sortedNames.forEach(name => {
                    if (name === "CHECK_AUTH" || name === "TEST") return;
                    const m = data[name];
                    const isOnline = m.online ? 'is-online' : 'is-offline';
                    
                    const rNum = extractRankNumber(m.rank);
                    const rClass = `rank-${rNum}`;

                    list.innerHTML += `
                        <tr class="${isOnline}">
                            <td><div class="avatar-circle">${name[0]}</div> <b>${name}</b></td>
                            <td><span class="rank-badge ${rClass}">${m.rank}</span></td>
                            <td class="warn-count">${m.warns || 0} / 3</td>
                            <td class="status-cell" onclick="togglePlayerStatus('${name}', ${m.online})">
                                <span class="pulse"></span><span class="status-text"></span>
                            </td>
                        </tr>
                    `;
                });

                updateStats();
            } catch (e) {
                console.log("Ошибка загрузки данных");
            }
        }

        async function togglePlayerStatus(name, currentStatus) {
            await fetch('/admin/update-member', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ password: "01050302", name: name, online: !currentStatus })
            });
            loadData();
        }

        function updateStats() {
            const total = document.querySelectorAll('#member-list tr').length;
            const online = document.querySelectorAll('#member-list tr.is-online').length;
            document.getElementById('total-count').innerText = total;
            document.getElementById('online-count').innerText = online;
        }

        loadData();
        setInterval(loadData, 5000);
    </script>
</body>
</html>